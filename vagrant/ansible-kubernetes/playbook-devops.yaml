---
- hosts: master-node
  vars:
    DATA_PATH: /opt/kubernetes/examples
  become: true
  tasks:

  - name: Copy YAML Files
    copy: src={{ item.src }} dest={{ item.dest }}
    with_items:
      - { src: '/opt/kubernetes/examples/', dest: "{{ DATA_PATH }}" }

  - name: Install Calico Pod Network
    command: kubectl apply -f "{{ DATA_PATH }}/admin/"calico.yaml

#  - name: 1 minute wait for initialization
#    pause:
#      minutes: 1

  - name: Install Nginx Ingress
    shell: 
        kubectl apply
        -f "{{ DATA_PATH }}/admin/"ingress-nginx.yaml

  - name: Install Dashboard
    shell:
        kubectl apply
        -f "{{ DATA_PATH }}/admin/"dashboard.yaml
        -f "{{ DATA_PATH }}/admin/"dashboard-admin.yaml
        -f "{{ DATA_PATH }}/admin/"dashboard-read-only.yaml

  - name: Install Prometheus & Grafana
    shell: |
      helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      helm search repo prometheus-community
      helm repo update
      kubectl create ns devops-monitoring
      helm install prometheus prometheus-community/kube-prometheus-stack --namespace devops-monitoring

  - name: Configure NodePort for Prometheus & Grafana
    shell: |
      kubectl apply
        -f "{{ DATA_PATH }}/monitoring/"monitoring-grafana-nodeport.yaml
        -f "{{ DATA_PATH }}/monitoring/"monitoring-prometheus-nodeport.yaml